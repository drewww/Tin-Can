<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-type" content="text/html" charset="utf-8">
	<title>Tin Can Meeting System</title>
	
	<!-- iPhone specific viewport sizing instructions. -->
	<meta name="viewport" content="width=320; initial-scale=1.0; minimum-scale=1.0; maximum-scale=1.0; user-scalable=0;">
	<link rel="apple-touch-icon-precomposed" href="{{static_url('images/demoIcon.png')}}" />
	
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
	<script type="text/javascript" src="{{static_url('js/Timeline.js')}}"></script>
	<script type="text/javascript" src="{{static_url('js/util.js')}}"></script>
	<script type="text/javascript" src="{{static_url('js/ConnectionManager.js')}}"></script>
	<script type="text/javascript" src="{{static_url('js/StateManager.js')}}"></script>
	<script type="text/javascript" src="{{static_url('js/model.js')}}"></script>
	<!--jqueryui only has Effects Core, Effect "Highlight", and Effect "Slide"-->
	<script type="text/javascript" src="{{static_url('js/jquery-ui-1.8.6.custom.min.js')}}"></script>


<script type="text/javascript" charset="utf-8">
	// We'll put all our code here.
	
	var localUser;
	
	$("document").ready(function() {
		
		// On load, grab data from the server so we can pick a user
		// to connect as. 
		conn = connection;
		
		
		
		//for the disclosure arrow
		function arrowToggle(el) {
			if ($(el).html().charCodeAt(0)=='9654') {
				$(el).html('&#9660;');
			} else {
				$(el).html('&#9654;');
			}
		}
		function arrowDown(el) {
			$(el).html('&#9660;');
		}
		function arrowRight(el) {
			$(el).html('&#9654;');
		}
		
		function hideDetails(e) {
			//e is target li
			$(e).find('.details').slideUp();
			arrowRight($(e).find('.arrow'));
		}
		
		function revealDetails(e) {
			//e is target li
			if($(e).parent().attr('id')=='tasks') {
				hideDetails($('#tasks li'));
			}
			$(e).find('.details').slideDown();
			arrowDown($(e).find('.arrow'));
		}

		function meetingObjectToggle(e) {
			return (function() {
				if (! $(e).find('.details').hasClass('current')) {
					$(e).find('.details').css('display','none');
				} else {
					arrowToggle($(e).find('.text').prev());
				}
				$(e).find('.text').click(function(){
					if($(e).parent().attr('id')=='tasks') {
						//if element is in the #task list then we need accordion behavior
						//on show, all other tasks must be hidden
						//on hide, nothing much to it
						if(!$(e).find('.details').is(':visible')) {
							hideDetails($('#tasks li'));
							revealDetails(e);
						} else {
							hideDetails(e);
						}
					} else {
						//otherwise, element is in #topics list and we don't need accordion behavior
						$(this).parent().parent().find('.details').slideToggle();
						arrowToggle($(this).prev());
					}
				});
			});
		}
		
		function assignTaskAction(e) {
			return (function() {
				var task = $(e).closest('li').attr('id');
				var user = $(e).parent().find('.participants').val();
				conn.assignTask(task,user);
			});
		}

		$('#tasks li, #topics li').each(function(){
			meetingObjectToggle($(this))();
		});

		$('#tasks input[type=submit].assign').click(function(){
			var taskUUID = $(this).closest('li').attr('id');
			var userUUID = $(this).parent().find('.participants').val();
			conn.assignTask(taskUUID,userUUID);
			return false;
		});
		
		$('#tasks input[type=submit].deassign').click(function(){
			var taskUUID = $(this).closest('li').attr('id');
			conn.deassignTask(taskUUID);
			return false;
		});
		
		$('#topics input[type=submit].start').click(function(){
			var topicUUID = $(this).closest('li').attr('id');
			conn.updateTopic(topicUUID,"CURRENT");
			return false;
		});
		
		$('#topics input[type=submit].stop').click(function(){
			var topicUUID = $(this).closest('li').attr('id');
			conn.updateTopic(topicUUID,"PAST");
			return false;
		});
		
		$('#topics input[type=submit].restart').click(function(){
			var topicUUID = $(this).closest('li').attr('id');
			conn.restartTopic(topicUUID);
			return false;
		});

		conn.addListener({connectionEvent: function(e) {
			
			switch(e.eventType) {
				
				// case "LOGIN_COMPLETE":
				// 	// we should be able to back out the meeting from the
				// 	// user object. 
				// 	console.log("localUser: " + localUser);
				// 	
				// 	conn.joinRoom(localUser.loc.meeting.room.uuid);
				// 	break;
				// 
				// case ""
				case "NEW_TOPIC":
					var topicElement = $("#topics").children().first().clone();
					var topic = e["results"]["topic"];
					//set topic id
					topicElement.attr('id',topic["uuid"]);
					//set .text div
					topicElement.find('.text').html(topic["text"]);
					//set created by and started at (assuming startTime is null)
					var createdBy = state.getObj(topic["createdBy"],User);
					topicElement.find('.createdby').html("Created by <strong>"+createdBy.name+"</strong> <span>Not started</apn>");
					//add start form
					var html = '<form>';
					html += '<input type="submit" value="Start" class="start">';
					html += '</form>';
					topicElement.find('.controlForm').html(html);
					topicElement.find('.start').click(function(){
						conn.updateTopic(topic["uuid"],"CURRENT");
						return false;
					});
					//add onclick behavior
					meetingObjectToggle(topicElement)();
					arrowDown(topicElement.find('.arrow'));
					topicElement.find('.details').css('display','block');
					$("#topics").append(topicElement);
					break;
				case "UPDATE_TOPIC":
					var topicUUID = e["params"]["topicUUID"];
					topic = state.getObj(topicUUID,Topic);
					if (topic.status == "PAST") {
						stopTime = topic.stopTime.getTime()/1000;
						$('#'+topicUUID+' .createdby span').first().html('Ended '+timesince(stopTime));
						var html = '<form>';
						html += '<input type="submit" value="Restart" class="restart">';
						html += '</form>';
						$('#'+topicUUID+' .controlForm').html(html);
						$('#'+topicUUID+' .restart').click(function(){
							conn.restartTopic(topicUUID);
							return false;
						});
						revealDetails($('#'+topicUUID));
					} else if (topic.status == "CURRENT") {
						$('#'+topicUUID+' .createdby span').first().html('Started just now');
						var html = '<form>';
						html += '<input type="submit" value="Stop" class="stop">';
						html += '</form>';
						$('#'+topicUUID+' .controlForm').html(html);
						$('#'+topicUUID+' .stop').click(function(){
							conn.updateTopic(topicUUID,"PAST");
							return false;
						});
						revealDetails($('#'+topicUUID));
					}
					revealDetails($('#'+topicUUID));
					$('#'+topicUUID+' .createdby span').css('background-color','#ffff99');
					$('#'+topicUUID+' .createdby span').animate({
						'background-color': '#FFF'
					},3000);
					break;
				case "NEW_TASK":
					var taskElement = $("#tasks").children().first().clone();
					var task = e["results"]["task"];
					//set task id
					taskElement.attr('id',task["uuid"]);
					//set .text div
					taskElement.find('.text').html(task["text"]);
					//set created by and created at
					var createdBy = state.getObj(task["createdBy"],User);
					taskElement.find('.createdby').html("Created by <strong>"+createdBy.name+"</strong> <span>"+timesince(task['createdAt'])+"</span>");
					//assuming that the new task is not assigned
					taskElement.find('.assignedto').html("Not assigned");
					//add onclick behavior
					meetingObjectToggle(taskElement)();
					//add assign form
					var html = '<form>';
					html += '<input type="submit" value="Assign" class="assign">&nbsp;to&nbsp;';
					html += '<select class="participants">';
					var participants = conn.meeting.getCurrentParticipants();
					var x;
					for (x in participants) {
						html += '<option value="'+participants[x].uuid+'">'+participants[x].name+'</option>';
					}
					html += '</select>';
					html += '</form>';
					taskElement.find('.assignform').html(html);
						
					taskElement.find('input[type=submit].assign').click(function(){
						var task = $(this).closest('li').attr('id');
						var user = $(this).parent().find('.participants').val();
						conn.assignTask(task,user);
						return false;	
					});
					arrowDown(taskElement.find('.arrow'));
					taskElement.find('.details').css('display','block');
					$("#tasks").prepend(taskElement);
					setTimeout(function() {
						taskElement.find('.details').slideUp();
						arrowRight(taskElement.find('.arrow').first());
					},500);
					break;
				case "ASSIGN_TASK":
					var taskUUID = e['params']['taskUUID'];
					if (e['params']['deassign'] == false) {
						var assignedTo = state.getObj(e['params']['assignedTo'],User);
						$('#'+taskUUID+' .assignedto').first().html('Assigned to <strong>'+assignedTo.name+'</strong>');
						$('#'+taskUUID+' .assignform').first().html('<form><input type="submit" value="Deassign" class="deassign"/></form>');
						$('#'+taskUUID+' input[type=submit].deassign').click(function(){
							conn.deassignTask(taskUUID);
							return false;
						});
					} else {
						$('#'+taskUUID).find('.assignedto').html('Not assigned');
						var html = '<form>';
						html += '<input type="submit" value="Assign" class="assign">&nbsp;to&nbsp;';
						html += '<select class="participants">';
						var participants = conn.meeting.getCurrentParticipants();
						var x;
						for (x in participants) {
							html += '<option value="'+participants[x].uuid+'">'+participants[x].name+'</option>';
						}
						html += '</select>';
						html += '</form>';
						$('#'+taskUUID).find('.assignform').html(html);
						$('#'+taskUUID+' input[type=submit].assign').click(function(){
							assignTaskAction($(this))();
							return false;
						});
					}
					revealDetails($('#'+taskUUID));
					$('#'+taskUUID).find('.assignedto').css('background-color','#ffff99').animate({
						'background-color': '#DDD'
					},{
						'duration': 3000,
						'queue': false
					});
					console.log('ddd');
					break;
					
				case "GET_STATE_COMPLETE":
					var users = state.getUsers();

					// Figure out which user is 'Drew' and then log in as them.
					var selectedUser = null;
					for(var index in users) {
						var user = users[index];
						console.log(user.name);
						if(user.name=="Drew") {
							// Connect as that user.
							selectedUser = user;
							// Drop out of the loop.
							break;
						}
					}

					// Connect as the user.
					localUser = selectedUser;
					conn.setUser(selectedUser.uuid);
					break;
				case "LOGIN_COMPLETE":
					$("#login").hide();
					$("#logged_in").show();
					break;
			}
			
			//tabs
			$('#navbar h1').each(function(i,j){
				$(this).click(function(){
					$('.current').removeClass('current');
					$(this).addClass('current');
					$('#maindivs > div').each(function(k,l) {
						if (k==i) $(this).show();
						else $(this).hide();
					});
				});
				if ($(this).hasClass('current')) {
					$('#maindivs > div').each(function(k,l) {
						if (k==i) $(this).show();
						else $(this).hide();
					});
				}
			});
			
		}});

		// Tell the connection manager to load state so we can pick
		// the uuid of the person we want. 
		conn.getState();
		
		// Execution picks up in the connection manager event handler
		// above, in GET_STATE_COMPLETE.
		
		$("#login").click(function() {conn.connect();});
		
		$("#submit_new_task").click(function() {
			conn.addTask($("#new_task").val());
			$("#new_task").val("new task...");
			return false;
		});
		
		$("#submit_new_topic").click(function() {
			conn.addTopic($("#new_topic").val());
			$("#new_topic").val("new topic...");
			return false;
		});
		
		$("#new_task").click(function() {
			$("#new_task").val("");
		});
		
		$("#new_topic").click(function() {
			$("#new_topic").val("");
		});
		
		$("#login").show();
		$("#logged_in").hide();
		
	});
	
	
</script>

<style type="text/css" media="screen">
	/* General styles */
	
	body {
		padding: 0px;
		margin: 0px;
		
		font-family: "Century Gothic", Helvetica, sans-serif;
	}
	
	a {
		text-decoration: none;
		font-weight: bold;
		color: black;
	}
	
	#navbar {
		text-align: center;
		background-color: #EEE;
	}
	
	#navbar h1 {
		margin: 10px 5px 0;
		border-top-right-radius: 3px;
		border-top-left-radius: 3px;
		padding-bottom: 3px;
	}
	
	#navbar h1.current {
		background-color: #FFF;
	}
	
	h1 {
		padding-top: 10px;
		margin-top: 0;
		margin-bottom: 5px;
		font-size: 1.25em;
		display: inline-block;
		clear: left;
		width: 40%;
		text-align: center;
	}
	
	/* Header / Footer setup. */
	header, footer {
		/*width: 100%;*/
		height: 30px;
		background-color: #444444;
		color: #DDDDDD;
		padding: 5px;
	}
	
	header, footer a {
		color: white;
	}
	
	footer {
		font-size: 0.5em;
	}
	
	#logo {
		width: 30px;
		height: 30px;
		
		float: left;
		margin-right: 5px;
	}
	
	#title {
		font-size: 1.8em;
		float: left;
		font-weight: bold;
	}
	
	#identity {
		float: right;
		margin-top: 5px;
		margin-right: 15px;
	}

	#taskdiv, #topicdiv {
		padding: 5px;
	}

	/* Task related styles. */
	
	.add_form {
		width: 100%;
	}
	
	.item_text {
		width: 240px;
		margin-right: 5px;
		float: left;
	}
	
	.submit_item {
		width: 40px;
	}
	
	ul {
		margin-left: 0px;
		margin-top: 10px;
		padding: 0px;
	}
	
	li {
		list-style: none;
		margin: 0 10px 10px;
		background-color: #EEE;
		padding: 5px;
		border-radius: 3px;
	}
	
	#logged_in img {
		margin-right: 5px;
	}
	
	.arrow {
		float: left;
		width: 20px;
		text-align: center;
		font-size: 11px;
		color: #AAA;
		clear: left;
		position: relative;
		top: 2px;
	}
	.text {
		float: left;
		width: 250px;
	}
	.details {
		padding-left: 20px;
		padding-bottom: 5px;
		font-size: 12px;
		clear: both;
	}
	.clearfix {
		clear: both;
	}
	.details > div > span {
		color: #888;
		background-color: #FFF;
	}
	.assignedto {
		background-color: #DDD;
		display: inline-block;
		padding: 2px;
		margin: 2px 0;
	}
	#tasks p, #topics p {
		margin: 0;
	}
	
	footer {
		margin-top: 10px;
		clear: both;
	}
	
</style>
</head>

<body>
<header>
	<img id="logo" src="{{static_url('images/mini_logo.png')}}"/>
	<div id="title">TIN CAN</div>
	<div id="identity"><input type="button" id="login" value="login">
	<div id="logged_in"><img src="{{static_url('images/user.png')}}">Drew</div>
	</div>
</header>
<div id="container">
<div id="navbar">
	<h1 class="current"><img src="{{static_url('images/note.png')}}"/>&nbsp;TASKS</h1>
	<h1><img src="{{static_url('images/comments.png')}}"/>&nbsp;TOPICS</h1>
</div>

<div id="maindivs">

<div id="taskdiv">

	<div id="add_task" class="add_form">
	<form action="" method="get" accept-charset="utf-8">
		<input type="text" name="new_task" value="new task..." id="new_task" class="item_text"/>
		<input type="submit" value="Add" id="submit_new_task" class="submit_item"/>
	</form>
	</div>

	<ul id="tasks">
	{% for task in tasks %}

	<li id="{{task.uuid}}">
	
		<div class="main">
			<div class="arrow">&#9654;</div>
			<div class="text">{{task.text}}</div>
		</div>
		<div class="details">
			{% import util %}
			<div class="createdby">Created by <strong>{{task.createdBy.name}}</strong> <span>{{util.timesince(task.createdAt)}}</span></div>
			{% if task.assignedTo!=None %}
			<div class="assignedto">Assigned to <strong>{{task.assignedTo.name}}</strong></span></div>
			<div class="assignform">
				<form>
					<input type="submit" value="Deassign" class="deassign">
				</form>
			</div>	
			{% else %}
			<div class="assignedto">Not assigned</div>
			<div class="assignform">
				<form>
					<input type="submit" value="Assign" class="assign">&nbsp;to&nbsp;
					<select class="participants">
						{% for participant in participants %}
						<option value="{{participant.uuid}}">{{participant.name}}</option>
						{% end %}
					</select>
				</form>
			</div>
			{% end %}
		</div>
		<div class="clearfix"></div>
	</li>
	{% end %}
	</ul>
	
</div><!--end #taskdiv-->

<div id="topicdiv">

	<div id="add_topic" class="add_form">
	<form action="" method="get" accept-charset="utf-8">
		<input type="text" name="new_topic" value="new topic..." id="new_topic" class="item_text"/>
		<input type="submit" value="Add"/ id="submit_new_topic" class="submit_item">
	</form>
	</div>

	<ul id="topics">
	{% for topic in topics %}
	<li id="{{topic.uuid}}">
		<div class="main">
			<div class="arrow">&#9654;</div>
			<div class="text">{{topic.text}}</div>	
		</div>
		<div class="details{% if topic.status=="CURRENT" %} current{% end %}">
			{% import util %}
			{% if topic.status=="PAST" %}
			<div class="createdby">
				Created by <strong>{{topic.createdBy.name}}</strong>
				<span>Ended {{util.timesince(topic.stopTime)}}</span>
			</div>
			<div class="controlForm">
				<form>
					<input type="submit" value="Restart" class="restart">
				</form>
			</div>
			{% elif topic.status=="CURRENT" %}
			<div class="createdby">
				Created by <strong>{{topic.createdBy.name}}</strong>
				<span>Started {{util.timesince(topic.startTime)}}</span>
			</div>
			<div class="controlForm">
				<form>
					<input type="submit" value="Stop" class="stop">
				</form>
			</div>
			{% else %}
			<div class="createdby">
				Created by <strong>{{topic.createdBy.name}}</strong>
				<span>Not Started</span>
			</div>
			<div class="controlForm">
				<form>
					<input type="submit" value="Start" class="start">
				</form>
			</div>
			{% end %}
		</div>
		<div class="clearfix"></div>
	</li>
	{% end %}
	</ul>
</div><!--end #topicdiv-->

</div><!--end #maindivs-->

</div>
<div style="clear:both"></div>
<footer>an <a href="http://media.mit.edu/">MIT Media Lab</a> / <a href="http://www.media.mit.edu/speech/">Speech + Mobility</a> project</footer>




</body>
</html>