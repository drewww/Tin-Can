<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<meta name="viewport" content="width=320; initial-scale=1.0; minimum-scale=1.0; maximum-scale=1.0; user-scalable=0;">
	<title>login</title>
<script type ="text/javascript" src = "http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>
<script type = "text/javascript" src = "../static/js/Timeline.js"></script>
<script type="text/javascript" src="{{static_url('js/util.js')}}"></script>
<script type="text/javascript" src="{{static_url('js/ConnectionManager.js')}}"></script>
<script type="text/javascript" src="{{static_url('js/StateManager.js')}}"></script>
<script type="text/javascript" src="{{static_url('js/model.js')}}"></script>
<script type="text/javascript" charset="utf-8">
	var userListElement;
	var roomListElement;
	var locListElement;
	var nameTemplate;
	var roomTemplate;
	var locationTemplate;
	var locTemplate
	var users;
//	var names = ["asdf", "asdf325", "omgomgomg","sd","sdf","sdfdsfgf","sdvdfbdfg","ssdf","sdg"];
	var names=[];
	var locs;
	var rooms = [[true,"asdf","meeting1",[4,3]], [true,"asdf325","meeting2",[5,4,2,1]], [false,"omgomgomg","meeting3's name is really long and goes past the edge",[7,1,3]],[false,"wtf","meeting4",[1,12]]];
	var roomNames=[];
	var locNames=[];
	var nameElements = [];
	var roomElements = [];
	var locElements = [];
	var select=true; //keeps track of whether you can select usernames
	var selected;
	
	$(document).ready(function(){
		
		users=state.getUsers();
		rooms=state.rooms; //I have no idea how I did this. will probably get replaced with a method
		locs=state.getLocations();
		for (user in users){
			names.push(users[user].name);
		}
		for (room in rooms){
			roomNames.push(rooms[room].name);
		}
		for (loc in locs){
			locNames.push(locs[loc].name);
		}
		
		userListElement = $("#usernamelist");
		nameTemplate = $("#nametemplate");
		
		nameTemplate.hide();
		$("#searchtype").hide();
		$("#newuser").hide();
		
		//generates initial username list
		for (var name in names){
			var newNameElement = createNewNameItem(names[name]);
			userListElement.append(newNameElement);
			nameElements.push(newNameElement);
		}
		
		$("#searchname").keyup(searchForUser);
		
		locListElement=$("#loclist");
		locTemplate=$("#loctemplate");
		locTemplate.hide();
		for (var loc in locs){
			var newLocElement = createNewLocItem(locs[loc]);
			locListElement.append(newLocElement);
			locElements.push(newLocElement);
		}
		$("#locs").hide();
		
		roomListElement = $("#roomlist");
		roomTemplate = $("#roomtemplate");
		locationTemplate = $("#locationtemplate");
		roomTemplate.hide();
		locationTemplate.hide();
	//	$(".name").hide();
		for (var x in rooms){
			var newRoomElement = createNewRoomItem(rooms[x]);
			roomListElement.append(newRoomElement);
			roomElements.push(newRoomElement);
		}
		$("#rooms").hide();
		
		$("#newname").keypress(enter);
	});
	
	function createNewNameItem(name){
		var newNameElement = nameTemplate.clone();
		newNameElement.find("div").html(name);
		newNameElement.show();
		return newNameElement;
	}
	
	function createNewLocItem(loc){
		var newLocElement = locTemplate.clone();
		newLocElement.find("div").html(loc.name);
		newLocElement.show();
		return newLocElement;
	}
	
	function createNewRoomItem(room){
		newRoomElement = roomTemplate.clone();
		if (true){ //assume every room has a current meeting
			newRoomElement.find("strong").html(room.name);
		}
		else{
			newRoomElement.find("em").html(room.name);
		}
		newRoomElement.find("div.room").append(" - " + room.currentMeeting);
		if (room.currentMeeting!=null){
			for (var y in room.currentMeeting.locs){
				newloc = locationTemplate.clone();
				newloc.prepend(room.currentMeeting.locs[y]);
				newloc.show();
				newRoomElement.find("ul").append(newloc);
			}
		}
		newRoomElement.data("timeline",new Timeline(newRoomElement.find("canvas")[0]));
		newRoomElement.data("timeline").start();
		newRoomElement.show();
		return newRoomElement;
	}
	
	//hide all elements. go through names. if a name is in list, show the name element.
	function displayList(list){
	//	$(".name").hide();
		for (var name in names){
			if ($.inArray(names[name],list)>=0){
				nameElements[name].show();
			}
		}
	}
	
	function toggleAdd(){
		clearSearch();
		var addName=$("#newuser")[0];
		$("#searchtype").hide();
		
		if (addName.style.display!="block"){
			addName.style.display="block";
			$("#newname").focus();
			select=false;
		}
		else{
			$("#newname")[0].value="";
			addName.style.display="none";
			select=true;
		}
	}
	
	function enter(e){
		if (e.which==13){
			$("#submit").focus();
			submitNewUser();
		}
	}
	
	function submitNewUser(){
		var newName=$("#newname")[0].value;
		if (newName!=""){
			$("#newname")[0].value="";
			var newNameElement = createNewNameItem(newName);
			names.splice(0,0,newName);
			newNameElement.insertAfter("#nametemplate");
			nameElements.splice(0,0,newNameElement);
			toggleAdd();
		//	displayList(names);
			highlightUser(newNameElement[0]);
		}
	}
	
	function toggleSearch(){
		select=true;
		$(".name").css("background","white");
		search=$("#searchtype")[0];
		$("#newuser").hide();
		
		if (search.style.display!="block"){
			search.style.display="block";
			$("#searchname").focus();
		}
		else{
			$("#searchname")[0].value="";
			search.style.display="none";
			displayList(names);
		}
	}
	
	function searchForUser(){
		$(".name").css("background","white");
		searchName=$("#searchname")[0].value.toUpperCase();
		var newList = new Array();
		for (var name in names){
			if (names[name].substring(0,searchName.length).toUpperCase()==searchName){
				newList.push(names[name]);
			}
		}
		displayList(newList);
	}
	
	function clearSearch(){
		$(".name").css("background","white");
		$("#searchname")[0].value="";
		displayList(names);
		$("#searchname").focus();
	}
	
	//highlights username or closes add-user-bar
	function selectUser(item){
		if (select){
			$("#locs").show();
			username = item.find("div").html();
			user=users[$.inArray(username,names)];
			$("#currentuser").html("logged in as: " + user.name);
			if($("#locs").offset().left>=5){
				slideLeft($("#users").offset().left,$("#locs").offset().left,$("#rooms").offset().left);
				var t = setTimeout("selectUser(selected)", 2);
			}
			else{
				$("#users").hide();
				$("#locs").offset({left:0,top:0});
				$("#users").offset({left:-320,top:0});
				$("#rooms").offset({left:320,top:0});
				connection.setUser(user.uuid);
				connection.connect();
			}
		}
		else{
			toggleAdd();
		}
	}
	
	function slideLeft(userspos,locspos,roomspos){
		$("#users").offset({left:userspos-5,top:0});
		$("#locs").offset({left:locspos-5,top:0});
		$("#rooms").offset({left:roomspos-5,top:0});
	}
	
	function slideRight(userspos,locspos,roomspos){
		$("#users").offset({left:userspos+5,top:0});
		$("#locs").offset({left:locspos+5,top:0});
		$("#rooms").offset({left:roomspos+5,top:0});
	}
	
	function highlightUser(item){
		$(".name").css("background","white");
		if (select){
			item.style.background="#00CCFF";
			selected = $(item);
		}
		selectUser(selected);
	}
	
	function statusbar(item){
		item.data("timeline").draw();
	}
	
	function highlightLoc(item){
		$(".loc").css("background","white");
		item.style.background="#00CCFF";
		selected=$(item)
		selectLoc(selected);
	}
	
	function selectLoc(item){
		$("#rooms").show();
		locname = item.find("div").html();
		loc=locs[$.inArray(locname,locNames)];
		$("#currentloc").html("joined location: " + loc.name);
		if($("#rooms").offset().left>=5){
			slideLeft($("#users").offset().left,$("#locs").offset().left,$("#rooms").offset().left);
			var t = setTimeout("selectLoc(selected)", 2);
		}
		else{
			$("#locs").hide();
			$("#rooms").offset({left:0,top:0});
			$("#locs").offset({left:-320,top:0});
			$("#users").offset({left:-640,top:0});
			connection.joinLocation(loc.uuid);
		}
	}
	
	function selectRoom(item){
		$(".meetingroom").css("background","white");
		roomname = $(item).find("div").find("strong").html();
		room=rooms[$.inArray(roomname,roomNames)];
		connection.joinRoom(room.uuid);
		item.style.background="#00CCFF";
		statusbar($(item));
	}
	
	function backToUsers(){
		$("#users").show();
		if($("#users").offset().left<=-5){
			slideRight($("#users").offset().left,$("#locs").offset().left,$("#rooms").offset().left);
			var t = setTimeout("backToUsers()", 2);
		}
		else{
			$("#locs").hide();
			$("#rooms").offset({left:640,top:0});
			$("#locs").offset({left:320,top:0});
			$("#users").offset({left:0,top:0});
		}
	}
	
	function backToLocs(){
		$("#locs").show();
		if($("#locs").offset().left<=-5){
			slideRight($("#users").offset().left,$("#locs").offset().left,$("#rooms").offset().left);
			var t = setTimeout("backToLocs()", 2);
		}
		else{
			$("#rooms").hide();
			$("#rooms").offset({left:320,top:0});
			$("#locs").offset({left:0,top:0});
			$("#users").offset({left:-320,top:0});
		}
	}
	
</script>

<style type="text/css" media="screen">
	body{
		margin:0px;
	}
	div{
		margin:0px;
	}
	#usernamelist,#roomlist,#loclist{
		border:solid;
		width:320px;
		list-style-type:none;
		padding:0px;
		margin:0px;
	}
	#users{
		float:left;
		position:absolute;
		top:0px;
		left:0px;
	}
	#locs{
		float:left;
		position:absolute;
		top:0px;
		left:320px;
	}
	#rooms{
		float:left;
		position:absolute;
		top:0px;
		left:640px;
	}
	li{
		border-bottom: 1px solid black;
	}
	.user{
		width:320px;
		height:50px;
		margin:none;
		padding:none;
	}
	.loc{
		width:320px;
		height:50px;
		margin:none;
		padding:none;
	}
	.meetingroom{
		width:320px;
		height:90px;
		margin:none;
		padding:none;
		clear:both;
		position:relative;
	}
	.participants{
		margin-left:30px;
		float:left;
		padding:0px;
		height:50px;
		font-family:"Arial",sans-serif;
		width:260px;
		text-align:center;
		list-style-type:none;
	}
	.location{
		font-size:30px;
		display:inline;
		border: 1px solid #0066FF;
		padding:0px;
	}
	.figure{
		margin:0px;
		padding:0px;
	}
	.room{
		font-size:20px;
		width:320px;
		font-family:"Arial",sans-serif;
		white-space:nowrap;
		overflow:hidden;
	}
	.statusbar{
		height:15px;
		width:300px;
		margin-left:5px;
		margin-right:5px;
		position:absolute;
		top:70px;
		left:5px;
	}
	#back{
		width:100px;
		float:left;
		padding-top:10px;
		padding-bottom:10px;
		margin-left:5px;
	}
	.status{
		width:25px;
		float:left;
		padding-top:12px;
		padding-bottom:12px;
	}
	.next{
		width:25px;
		float:right;
		padding-top:11px;
		padding-bottom:11px;
	}
	.icon{
		width:40px;
		float:left;
		padding-top:5px;
		padding-bottom:5px;
	}
	.username{
		width:230px;
		float:left;
		font-family:"Arial",sans-serif;
		padding-top:15px;
		padding-bottom:15px;
	}
	.locname{
		float:left;
		font-family:"Arial",sans-serif;
		padding-top:15px;
		padding-bottom:15px;
		padding-left:25px;
	}
	#add{
		width:100px;
		text-align:right;
		float:left;
		padding-top:10px;
		padding-bottom:10px;
	}
	#title{
		width:120px;
		text-align:center;
		font-size:20px;
		float:left;
		font-family:"Arial",sans-serif;
		padding-top:15px;
		padding-bottom:15px;
	}
	#search{
		width:100px;
		float:right;
		padding-top:10px;
		padding-bottom:10px;
	}
	#header{
		width:320px;
		height:50px;
		margin:none;
		padding:none;
		clear:both;
		border:solid;
	.textbox{
		height:25px;
		margin-top:7px;
		margin-bottom:7px;
		margin-left:5px;
		width:150px;
		font-size:17px;
	}
	#newuser{
		display:none;
	}
	#searchtype{
		display:none;
	}

</style>
</head>

<body>
	<div id = "users">
	<div id="header">
		<div id = "add"><button id="addbutton" onclick = "toggleAdd();">Add</button></div>
		<div id ="title">Users</div>
		<div id ="search"><button id="searchbutton" onclick = "toggleSearch();">Find</button></div>
	</div>
	<div id="content">
	<ul id = "usernamelist">
		<li id = "newuser" class = "user">
			<label for="name"></label><input type="text" name="name" value="" id="newname" class="textbox">
			<button id = "submit" onclick="submitNewUser();">Create!</button>
		</li>
		<li id = "searchtype" class = "user">
			<label for="name"></label><input type="text" name="name" value="" id="searchname" class="textbox">
			<button id = "clearsearch" onclick="clearSearch();">x</button>
			<button id = "cancelsearch" onclick="toggleSearch();">Cancel</button>
		</li>
		<li id ="nametemplate" class="user name" onclick = "highlightUser(this);">
			<img class = "status" src = "{{ static_url("images/online.png")}}">
			<div class = "username"></div>
			<img class = "icon" src = "{{ static_url("images/icon.png")}}">
			<img class = "next" src = "{{ static_url("images/next.png")}}">
		</li>
	</ul>
	</div>
	</div>
	
	<div id = "locs">
	<div id="header">
		<div id = "back"><button id="backbutton" onclick="backToUsers();">< Users</button></div>
		<div id ="title">Locations</div>
		<div id = "currentuser">logged in as: </div>
	</div>
	<ul id = "loclist">
		<li id ="loctemplate" class="loc name" onclick = "highlightLoc(this);">
			<div class = "locname"></div>
			<img class = "next" src = "{{ static_url("images/next.png")}}">
		</li>
	</ul>
	</div>
	
	<div id = "rooms">
	<div id="header">
		<div id = "back"><button id="backbutton" onclick="backToLocs();">< Locations</button></div>
		<div id ="title">Rooms</div>
		<div id = "currentloc">location: </div>
	</div>
	<ul id = "roomlist">
		<li id = "locationtemplate" class = "location"><img class = "figure" src = "{{ static_url("images/icon.png")}}"></li>
		<li id ="roomtemplate" class="meetingroom name" onclick = "selectRoom(this);">
			<div class = "room"><strong></strong><em></em></div>
			<ul class = "participants">
			</ul>
			<img class = "next" src = "{{ static_url("images/next.png")}}">
			<canvas class="statusbar" width=300 height=15><canvas>
		</li>
	</ul>
	</div>
</body>
</html>
